<div class="container mt-4">
    <h2>Admin: Docker & Environment Diagnostics</h2>
    <p class="text-muted">Quick actions for local development and debugging. Note: the web container must have access to the Docker socket for these to work.</p>

    <div class="card mb-3">
        <div class="card-header">Status</div>
        <div class="card-body">
            <div id="diag-status">Loading...</div>
            <div class="mt-3">
                <button id="btn-refresh-diag" class="btn btn-sm btn-outline-primary">Refresh</button>
            </div>
        </div>
    </div>

    <div class="card mb-3">
        <div class="card-header">Quick Actions</div>
        <div class="card-body">
            <div class="d-flex gap-2 mb-2">
                <button id="btn-up-db" class="btn btn-primary">Start DB (root compose)</button>
                <button id="btn-ps" class="btn btn-secondary">docker compose ps</button>
                <button id="btn-logs-web" class="btn btn-outline-secondary">Show web logs</button>
            </div>
            <div class="mb-2">
                <input id="env-name-input" class="form-control form-control-sm" placeholder="Environment name (e.g., crm)" />
            </div>
            <div class="d-flex gap-2">
                <button id="btn-up-env" class="btn btn-success">Start Environment</button>
                <button id="btn-down-env" class="btn btn-danger">Stop Environment</button>
                <button id="btn-logs-env" class="btn btn-outline-secondary">Show Environment Logs</button>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">Output</div>
        <div class="card-body">
            <pre id="admin-output" style="white-space: pre-wrap; max-height: 420px; overflow:auto;"></pre>
        </div>
    </div>
</div>

<script>
async function fetchDiag() {
    const out = document.getElementById('diag-status');
    const pre = document.getElementById('admin-output');
    out.textContent = 'Checking...';
    pre.textContent = '';
    try {
        const res = await fetch('/admin/diagnostics');
        const data = await res.json();
        out.innerHTML = `<div><strong>Docker:</strong> ${data.docker.available ? 'OK' : 'Missing'} â€” ${data.docker.message}</div>
                         <div><strong>PowerShell:</strong> ${data.powershell.available ? 'OK' : 'Missing'} ${data.powershell.path ? '('+data.powershell.path+')' : ''}</div>`;
    } catch (err) {
        out.textContent = 'Failed to fetch diagnostics: ' + err.message;
    }
}

async function runAction(path, opts={}) {
    const pre = document.getElementById('admin-output');
    pre.textContent = 'Running...';
    try {
        const res = await fetch(path, opts);
        const data = await res.json();
        pre.textContent = JSON.stringify(data, null, 2);
    } catch (err) {
        pre.textContent = 'Request failed: ' + err.message;
    }
}

document.getElementById('btn-refresh-diag').addEventListener('click', fetchDiag);

document.getElementById('btn-up-db').addEventListener('click', async () => {
    await runAction('/admin/docker/up_db', { method: 'POST' });
    await fetchDiag();
});

document.getElementById('btn-ps').addEventListener('click', async () => runAction('/admin/docker/ps'));

document.getElementById('btn-logs-web').addEventListener('click', async () => runAction('/admin/docker/logs', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({service: 'web'}) }));

async function envName() { return document.getElementById('env-name-input').value.trim(); }

document.getElementById('btn-up-env').addEventListener('click', async () => {
    const name = await envName();
    if (!name) return alert('Provide environment name');
    await runAction('/admin/docker/up_env', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ name }) });
});

document.getElementById('btn-down-env').addEventListener('click', async () => {
    const name = await envName();
    if (!name) return alert('Provide environment name');
    await runAction('/admin/docker/down_env', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ name }) });
});

document.getElementById('btn-logs-env').addEventListener('click', async () => {
    const name = await envName();
    if (!name) return alert('Provide environment name');
    // show the env history log file content if available
    await runAction(`/odoo/local_env/log/${encodeURIComponent(name)}`);
});

// Initial fetch
fetchDiag();
</script>